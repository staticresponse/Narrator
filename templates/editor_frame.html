<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/upload.css') }}">
    <title>{{ title }}</title>
    <style>
        .bin-container { display: flex; flex-wrap: wrap; gap: 10px; }
        .bin { width: 18%; padding: 10px; border: 1px solid #ddd; }
    </style>  
    <script>
        var speakers = {{ speakers | tojson | default('{}') }};

        function applySpeaker(speakerName) {
            let selection = window.getSelection();
            if (!selection.rangeCount) return;
            let range = selection.getRangeAt(0);
            let span = document.createElement("span");
            span.classList.add("badge", "bg-primary", "me-1");
            span.setAttribute("data-speaker", speakers[speakerName]);
            span.textContent = speakerName + " (" + speakers[speakerName] + ")";
            range.deleteContents();
            range.insertNode(span);
        }
        function saveText() {
        let editor = document.getElementById("editor");

        // Step 1: Loop through child nodes to find unwrapped text nodes
        let nodes = Array.from(editor.childNodes);
        nodes.forEach(node => {
            if (node.nodeType === Node.TEXT_NODE && node.textContent.trim() !== "") {
                let span = document.createElement("span");
                span.classList.add("badge", "bg-secondary", "me-1");
                span.setAttribute("data-speaker", "p364");  // Narrator speaker ID
                span.textContent = node.textContent;
                node.replaceWith(span);
            }
        });

        // Step 2: Collect and send updated content
        let content = editor.innerHTML;
        let formData = new FormData();
        formData.append("filename", "{{ filename }}");
        formData.append("edited_text", content);

        fetch("/save-text", {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(data => alert(data.message))
        .catch(error => console.error("Error:", error));
    }

    </script>
    <style>
        .speaker { font-weight: bold; }
        .editor-container {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 5px;
            background-color: #f8f9fa;
            min-height: 200px;
        }
    </style>
</head>
<body>

{% include 'navbar.html' %}

{% block content %}
{% endblock %}

</body>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{{ url_for('static', filename='src/bootstrap.bundle.min.js') }}"></script>
</html>
